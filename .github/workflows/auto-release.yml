name: Auto Release

on:
  push:
    branches:
      - release
      - release/*
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    - run: npm ci
    - run: npm run dist
    - uses: actions/upload-artifact@v4
      with:
        name: windows-executables
        path: dist/
        
  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    - run: npm ci
    - run: npm run dist
    - uses: actions/upload-artifact@v4
      with:
        name: macos-executables
        path: dist/
        
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    - run: npm ci
    - run: npm run dist
    - uses: actions/upload-artifact@v4
      with:
        name: linux-executables
        path: dist/

  auto-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Get version from package.json
      id: version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=v$VERSION" >> $GITHUB_OUTPUT
        echo "Version: v$VERSION"
        
    - name: Check if release exists
      id: check_release
      run: |
        if git tag -l "${{ steps.version.outputs.version }}" | grep -q "${{ steps.version.outputs.version }}"; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Release ${{ steps.version.outputs.version }} already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Release ${{ steps.version.outputs.version }} does not exist"
        fi
        
    - name: Download all artifacts
      if: steps.check_release.outputs.exists == 'false'
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Create Release
      if: steps.check_release.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        files: artifacts/**/*
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          🚀 **Automatic release from branch push**
          
          This release was automatically created from a push to the `release` branch.
          
          ## 📦 Downloads
          Choose the appropriate installer for your operating system:
          
          - 🪟 **Windows**: Download the `.exe` installer
          - 🍎 **macOS**: Download the `.dmg` file  
          - 🐧 **Linux**: Download the `.AppImage` file
          
          ## 🔄 Auto-generated
          Release notes and assets were automatically generated by GitHub Actions.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}